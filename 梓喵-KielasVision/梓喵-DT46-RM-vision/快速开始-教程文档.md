# 快速开始-教程文档

# 快速开始-教程文档

本教程帮助你在 **Ubuntu + ROS2** 环境下快速运行 梓喵 `DT-46-KielasVision` 项目，完成视觉识别与追踪的基本体验。

---

# 教程目录

## 1. 环境准备

- 1.1 安装 ROS2 Humble
- 1.2 安装 OpenCV
- 1.3 安装相机 SDK（Hik / MindVision）
- 1.4 配置 Git（SSH、代理）
- 1.5 配置 bashrc 快捷指令

## 2. 获取代码

- 2.1 克隆仓库
- 2.2 编译工作空间
- 2.3 检查依赖
- 2.4 训练分类器模型

## 3. 启动系统

- 3.1 USB 相机启动（推荐新手）
- 3.2 Hik 相机启动
- 3.3 MindVision 相机启动
- 3.4 nav 与非 nav 启动区别

## 4. 验证运行

- 4.1 查看话题列表
- 4.2 检查话题帧率
- 4.3 可视化检测结果（rqt / foxglove）

## 5. 调参入门

- 5.1 调整二值化阈值（binary_val）
- 5.2 设置识别颜色（detect_color）
- 5.3 display_mode 使用
- 5.4 tracker 基础参数调整

## 6. 成功标志

- 6.1 终端输出检测与追踪日志
- 6.2 `/detector/armors_info` 持续输出
- 6.3 `/tracker/target` 正常发布
- 6.4 rqt/foxglove 可见装甲板识别结果

## 1. 环境准备

### 系统要求

- 操作系统：Ubuntu 22.04（推荐）
- ROS2 发行版：Humble（已测试通过）
- OpenCV：版本 4.x
- Python：3.8+（用于训练脚本）
- PyTorch：1.8+（用于训练分类器）
- ONNX：用于导出模型

### 相机检查

```bash
ls /dev/video*v4l2-ctl --list-devicessudo usermod -aG video $USER   # 若权限不足，执行后需重新登录
```

### 安装 PyTorch 和相关库

```bash
pip install torch torchvision onnx
```

### Git 配置（首次使用必做）

```bash
# 配置用户名与邮箱
git config --global user.name "Kielas"
git config --global user.email "c1470759@outlook.com"
# 配置代理（如需要）
git config --global http.proxy http://127.0.0.1:7897
git config --global https.proxy https://127.0.0.1:7897
# 取消代理
git config --global --unset http.proxy
git config --global --unset https.proxy
```

### SSH Key 配置

```bash
ssh-keygen -t rsa -f ~/.ssh/id_rsa.github -C "mail@outlook.com"
```

生成后，将公钥内容添加到 GitHub → Settings → SSH and GPG keys。

### 详细环境配置参考

👉 Kielas 的 Notion 笔记（Linux 配置）

该笔记涵盖：

- 系统换源
- ROS2 安装
- Git/SSH 配置
- `.bashrc` alias 片段
- 常用 Linux 工具安装

---

## 2. 获取代码

```bash
mkdir -p ~/ros_ws/src
cd ~/ros_ws/src
git clone https://github.com/DT46-Vision/DT-46-KielasVision.git
cd ~/ros_ws
```

### 检查依赖

确保所有依赖已安装：

```bash
# 安装 rm_detector 依赖
rosdep install --from-paths src/DT-46-KielasVision/rm_detector --ignore-src -r -y
# 安装 rm_tracker 依赖
rosdep install --from-paths src/DT-46-KielasVision/rm_tracker --ignore-src -r -y
```

依赖清单：

- **rm_detector**: `rclcpp`, `sensor_msgs`, `std_msgs`, `cv_bridge`, `opencv4`, `rm_interfaces`
- **rm_tracker**: `rclpy`, `std_msgs`, `rm_interfaces`
- **测试依赖**:
    - **rm_detector**: `ament_lint_auto`, `ament_lint_common`
    - **rm_tracker**: `ament_copyright`, `ament_flake8`, `ament_pep257`, `python3-pytest`

### 构建项目

```bash
# 加载 ROS2 环境
source /opt/ros/humble/setup.bash
# 编译
colcon build --symlink-install
# 加载工作空间环境
source install/setup.bash
```

如需清理编译缓存：

```bash
rm -rf build install log
colcon build --symlink-install
```

### 训练分类器模型

1. **创建数据集文件夹**

```bash
mkdir -p ~/ros_ws/src/DT-46-KielasVision/datasets/1
mkdir -p ~/ros_ws/src/DT-46-KielasVision/datasets/2
mkdir -p ~/ros_ws/src/DT-46-KielasVision/datasets/3
mkdir -p ~/ros_ws/src/DT-46-KielasVision/datasets/4negative
```

1. **使用 CIFAR-100 作为负样本**

下载 CIFAR-100 数据集：https://www.cs.toronto.edu/~kriz/cifar.html

解压后，运行以下命令处理负样本：

```bash
cd ~/ros_ws/src/DT-46-KielasVision/training_scripts
python3 process_cifra100.py
```

1. **采集装甲板图案数据**
    - 启动相机节点与识别器：
        
        ```bash
        ros2 launch rm_detector usb_nav.launch.py
        ```
        
    - 将装甲板置于相机视野中，检查 `/detector/img_armor` 话题图像是否准确。
    - 改变装甲板姿态，确保角点检测准确，录制 rosbag：
        
        ```bash
        ros2 bag record /detector/img_armor -o armor_bag_<id>
        ```
        
        - 1号装甲板：`armor_bag_1`
        - 3号装甲板：`armor_bag_2`
        - 哨兵装甲板：`armor_bag_3`
    - 从 rosbag 提取图像：
        
        ```bash
        python3 extract_bag_bin.py armor_bag_1 datasets/1/
        python3 extract_bag_bin.py armor_bag_2 datasets/2/
        python3 extract_bag_bin.py armor_bag_3 datasets/3/
        ```
        
2. **数据集结构**

确保数据集文件夹结构如下：

```
datasets
├─1/        # 1号装甲板图案
├─2/        # 3号装甲板图案
├─3/        # 哨兵装甲板图案
├─4negative/ # 负样本（CIFAR-100 处理后）
```

1. **训练模型**

运行训练脚本：

```bash
cd ~/ros_ws/src/DT-46-KielasVision/training_scripts
python3 mlp_training.py
```

训练完成后，生成的 `mlp.onnx` 和 `labels.txt` 文件将保存在 `training_scripts` 目录下。

1. **将模型文件移到正确位置**

```bash
mv mlp.onnx ~/ros_ws/src/DT-46-KielasVision/rm_detector/model/
mv labels.txt ~/ros_ws/src/DT-46-KielasVision/rm_detector/model/
```

1. **更新参数文件**

编辑 `~/ros_ws/src/DT-46-KielasVision/rm_detector/config/detector_params.yaml`，确保 `cls_model_file` 指向 `mlp.onnx`：

```yaml
rm_detector:  ros__parameters:    cls_model_file: 'mlp.onnx'    ...
```

---

## 3. 启动系统

### USB 相机启动（推荐新手）

```bash
ros2 launch rm_detector usb_nav.launch.py
```

### Hik 相机启动

```bash
ros2 launch rm_detector hik.launch.py
ros2 launch rm_detector hik_nav.launch.py  # 带导航
```

### MindVision 相机启动

```bash
ros2 launch rm_detector mv.launch.py
ros2 launch rm_detector mv_nav.launch.py  # 带导航
```

### nav 与非 nav 启动区别

- **nav**：包含导航相关功能，发布 `/tracker/target` 话题（yaw/pitch/shoot_flag）。
- **非 nav**：仅发布 `/detector/armors_info` 话题，适合调试检测器。

---

## 4. 验证运行

### 查看话题列表

```bash
ros2 topic list
```

预期输出：

- `/detector/armors_info` (rm_interfaces/msg/ArmorsCppMsg)
- `/tracker/target` (rm_interfaces/msg/ArmorTracking, nav 模式)
- `/detector/bin_img` (sensor_msgs/msg/Image, 二值化图像)
- `/detector/result_img` (sensor_msgs/msg/Image, 检测结果图像)
- `/detector/img_armor` (sensor_msgs/msg/Image, 矩阵变换后的装甲板图像)

### 检查话题帧率

```bash
ros2 topic hz /detector/armors_info
ros2 topic hz /tracker/target
ros2 topic hz /detector/img_armor
```

### 可视化检测结果

- **rqt**：
    
    ```bash
    rqt
    ```
    
    打开 `Plugins → Visualization → Image View`，选择 `/detector/result_img`, `/detector/bin_img` 或 `/detector/img_armor`。
    
- **Foxglove**：
    
    ```bash
    ros2 launch foxglove_bridge foxglove_bridge_launch.xml port:=8765
    ```
    
    打开 Foxglove Studio，连接 `ws://localhost:8765`，查看图像与 `/detector/armors_info`。
    




- 二值化图像：

![bin.png](快速开始-教程文档/bin.png)

- 矩阵变换后的装甲板图像 + 检测结果：

![solve+res.jpg](快速开始-教程文档/solve+res.png)

---

## 5. 参数调试与配置

### 动态调参（命令行）

```bash
# 切换显示模式（同时发布二值化与识别结果图）
ros2 param set /rm_detector display_mode 2
# 调节二值化阈值
ros2 param set /rm_detector binary_val 120
# 调节追踪颜色（0=红, 1=蓝, 10=不追踪）
ros2 param set /rm_tracker tracking_color 0
```

### 动态调参（rqt GUI）

- 打开：`Plugins → Configuration → Parameters`
- 选择 `/rm_detector` 或 `/rm_tracker`
- 修改 `display_mode`, `binary_val`, `tracking_color` 等参数

### 修改配置文件（持久化）

- 检测器参数文件：`~/ros_ws/src/DT-46-KielasVision/rm_detector/config/detector_params.yaml`
- 追踪器参数文件：`~/ros_ws/src/DT-46-KielasVision/rm_tracker/config/tracker_params.yaml`

修改后重新运行 launch 文件即可生效。

---

## 6. 成功标志

- 终端输出检测与追踪日志
- `/detector/armors_info` 持续输出
- `/tracker/target` 正常发布
- rqt/foxglove 可见装甲板识别结果

---

## 7. 开发环境优化（可选）

推荐在 `~/.bashrc` 添加以下 alias 提升效率：

```bash
alias sb='source ~/.bashrc'
alias eb='nano ~/.bashrc'
alias cb='rm -rf build install log && colcon build --symlink-install'
alias si='source install/setup.bash'
alias rvh='ros2 launch rm_detector hik.launch.py'
alias rvnh='ros2 launch rm_detector hik_nav.launch.py'
alias rvm='ros2 launch rm_detector mv.launch.py'
alias rvnm='ros2 launch rm_detector mv_nav.launch.py'
alias rvnu='ros2 launch rm_detector usb_nav.launch.py'
alias rf='cd ~/ros_ws && source install/setup.bash && ros2 launch foxglove_bridge foxglove_bridge_launch.xml port:=8765'
alias stop='pkill -9 -f ros2'
```

---

## 8. 常见问题

- **相机无法打开**：检查 `/dev/video0` 是否存在，是否被其他程序占用（`fuser /dev/video0`）
- **没有检测结果**：用 **rqt** 查看 `/detector/bin_img`，调节 `binary_val`
- **帧率过低**：降低分辨率或关闭 `display_mode` 可视化
- **节点未启动**：确认已执行 `source /opt/ros/humble/setup.bash` 与 `source install/setup.bash`
- **训练失败**：检查 PyTorch 版本、数据集路径、图片格式是否正确

---

## 9. 下一步

- **操作指南**：切换相机驱动（Hik / MindVision）、启用串口通信…
- **参考文档**：完整参数清单、话题与消息类型…
- **解释文档**：IMM 追踪算法与弹道补偿原理…

---

✅ 至此，你已经能成功运行 `DT-46-KielasVision` 项目。