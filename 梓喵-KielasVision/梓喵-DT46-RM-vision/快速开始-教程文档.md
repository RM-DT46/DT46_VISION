# å¿«é€Ÿå¼€å§‹-æ•™ç¨‹æ–‡æ¡£

# å¿«é€Ÿå¼€å§‹-æ•™ç¨‹æ–‡æ¡£

æœ¬æ•™ç¨‹å¸®åŠ©ä½ åœ¨ **Ubuntu + ROS2** ç¯å¢ƒä¸‹å¿«é€Ÿè¿è¡Œ æ¢“å–µ `DT-46-KielasVision` é¡¹ç›®ï¼Œå®Œæˆè§†è§‰è¯†åˆ«ä¸è¿½è¸ªçš„åŸºæœ¬ä½“éªŒã€‚

---

# æ•™ç¨‹ç›®å½•

## 1. ç¯å¢ƒå‡†å¤‡

- 1.1 å®‰è£… ROS2 Humble
- 1.2 å®‰è£… OpenCV
- 1.3 å®‰è£…ç›¸æœº SDKï¼ˆHik / MindVisionï¼‰
- 1.4 é…ç½® Gitï¼ˆSSHã€ä»£ç†ï¼‰
- 1.5 é…ç½® bashrc å¿«æ·æŒ‡ä»¤

## 2. è·å–ä»£ç 

- 2.1 å…‹éš†ä»“åº“
- 2.2 ç¼–è¯‘å·¥ä½œç©ºé—´
- 2.3 æ£€æŸ¥ä¾èµ–
- 2.4 è®­ç»ƒåˆ†ç±»å™¨æ¨¡å‹

## 3. å¯åŠ¨ç³»ç»Ÿ

- 3.1 USB ç›¸æœºå¯åŠ¨ï¼ˆæ¨èæ–°æ‰‹ï¼‰
- 3.2 Hik ç›¸æœºå¯åŠ¨
- 3.3 MindVision ç›¸æœºå¯åŠ¨
- 3.4 nav ä¸é nav å¯åŠ¨åŒºåˆ«

## 4. éªŒè¯è¿è¡Œ

- 4.1 æŸ¥çœ‹è¯é¢˜åˆ—è¡¨
- 4.2 æ£€æŸ¥è¯é¢˜å¸§ç‡
- 4.3 å¯è§†åŒ–æ£€æµ‹ç»“æœï¼ˆrqt / foxgloveï¼‰

## 5. è°ƒå‚å…¥é—¨

- 5.1 è°ƒæ•´äºŒå€¼åŒ–é˜ˆå€¼ï¼ˆbinary_valï¼‰
- 5.2 è®¾ç½®è¯†åˆ«é¢œè‰²ï¼ˆdetect_colorï¼‰
- 5.3 display_mode ä½¿ç”¨
- 5.4 tracker åŸºç¡€å‚æ•°è°ƒæ•´

## 6. æˆåŠŸæ ‡å¿—

- 6.1 ç»ˆç«¯è¾“å‡ºæ£€æµ‹ä¸è¿½è¸ªæ—¥å¿—
- 6.2 `/detector/armors_info` æŒç»­è¾“å‡º
- 6.3 `/tracker/target` æ­£å¸¸å‘å¸ƒ
- 6.4 rqt/foxglove å¯è§è£…ç”²æ¿è¯†åˆ«ç»“æœ

## 1. ç¯å¢ƒå‡†å¤‡

### ç³»ç»Ÿè¦æ±‚

- æ“ä½œç³»ç»Ÿï¼šUbuntu 22.04ï¼ˆæ¨èï¼‰
- ROS2 å‘è¡Œç‰ˆï¼šHumbleï¼ˆå·²æµ‹è¯•é€šè¿‡ï¼‰
- OpenCVï¼šç‰ˆæœ¬ 4.x
- Pythonï¼š3.8+ï¼ˆç”¨äºè®­ç»ƒè„šæœ¬ï¼‰
- PyTorchï¼š1.8+ï¼ˆç”¨äºè®­ç»ƒåˆ†ç±»å™¨ï¼‰
- ONNXï¼šç”¨äºå¯¼å‡ºæ¨¡å‹

### ç›¸æœºæ£€æŸ¥

```bash
ls /dev/video*v4l2-ctl --list-devicessudo usermod -aG video $USER   # è‹¥æƒé™ä¸è¶³ï¼Œæ‰§è¡Œåéœ€é‡æ–°ç™»å½•
```

### å®‰è£… PyTorch å’Œç›¸å…³åº“

```bash
pip install torch torchvision onnx
```

### Git é…ç½®ï¼ˆé¦–æ¬¡ä½¿ç”¨å¿…åšï¼‰

```bash
# é…ç½®ç”¨æˆ·åä¸é‚®ç®±
git config --global user.name "Kielas"
git config --global user.email "c1470759@outlook.com"
# é…ç½®ä»£ç†ï¼ˆå¦‚éœ€è¦ï¼‰
git config --global http.proxy http://127.0.0.1:7897
git config --global https.proxy https://127.0.0.1:7897
# å–æ¶ˆä»£ç†
git config --global --unset http.proxy
git config --global --unset https.proxy
```

### SSH Key é…ç½®

```bash
ssh-keygen -t rsa -f ~/.ssh/id_rsa.github -C "mail@outlook.com"
```

ç”Ÿæˆåï¼Œå°†å…¬é’¥å†…å®¹æ·»åŠ åˆ° GitHub â†’ Settings â†’ SSH and GPG keysã€‚

### è¯¦ç»†ç¯å¢ƒé…ç½®å‚è€ƒ

ğŸ‘‰ Kielas çš„ Notion ç¬”è®°ï¼ˆLinux é…ç½®ï¼‰

è¯¥ç¬”è®°æ¶µç›–ï¼š

- ç³»ç»Ÿæ¢æº
- ROS2 å®‰è£…
- Git/SSH é…ç½®
- `.bashrc` alias ç‰‡æ®µ
- å¸¸ç”¨ Linux å·¥å…·å®‰è£…

---

## 2. è·å–ä»£ç 

```bash
mkdir -p ~/ros_ws/src
cd ~/ros_ws/src
git clone https://github.com/DT46-Vision/DT-46-KielasVision.git
cd ~/ros_ws
```

### æ£€æŸ¥ä¾èµ–

ç¡®ä¿æ‰€æœ‰ä¾èµ–å·²å®‰è£…ï¼š

```bash
# å®‰è£… rm_detector ä¾èµ–
rosdep install --from-paths src/DT-46-KielasVision/rm_detector --ignore-src -r -y
# å®‰è£… rm_tracker ä¾èµ–
rosdep install --from-paths src/DT-46-KielasVision/rm_tracker --ignore-src -r -y
```

ä¾èµ–æ¸…å•ï¼š

- **rm_detector**: `rclcpp`, `sensor_msgs`, `std_msgs`, `cv_bridge`, `opencv4`, `rm_interfaces`
- **rm_tracker**: `rclpy`, `std_msgs`, `rm_interfaces`
- **æµ‹è¯•ä¾èµ–**:
    - **rm_detector**: `ament_lint_auto`, `ament_lint_common`
    - **rm_tracker**: `ament_copyright`, `ament_flake8`, `ament_pep257`, `python3-pytest`

### æ„å»ºé¡¹ç›®

```bash
# åŠ è½½ ROS2 ç¯å¢ƒ
source /opt/ros/humble/setup.bash
# ç¼–è¯‘
colcon build --symlink-install
# åŠ è½½å·¥ä½œç©ºé—´ç¯å¢ƒ
source install/setup.bash
```

å¦‚éœ€æ¸…ç†ç¼–è¯‘ç¼“å­˜ï¼š

```bash
rm -rf build install log
colcon build --symlink-install
```

### è®­ç»ƒåˆ†ç±»å™¨æ¨¡å‹

1. **åˆ›å»ºæ•°æ®é›†æ–‡ä»¶å¤¹**

```bash
mkdir -p ~/ros_ws/src/DT-46-KielasVision/datasets/1
mkdir -p ~/ros_ws/src/DT-46-KielasVision/datasets/2
mkdir -p ~/ros_ws/src/DT-46-KielasVision/datasets/3
mkdir -p ~/ros_ws/src/DT-46-KielasVision/datasets/4negative
```

1. **ä½¿ç”¨ CIFAR-100 ä½œä¸ºè´Ÿæ ·æœ¬**

ä¸‹è½½ CIFAR-100 æ•°æ®é›†ï¼šhttps://www.cs.toronto.edu/~kriz/cifar.html

è§£å‹åï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤å¤„ç†è´Ÿæ ·æœ¬ï¼š

```bash
cd ~/ros_ws/src/DT-46-KielasVision/training_scripts
python3 process_cifra100.py
```

1. **é‡‡é›†è£…ç”²æ¿å›¾æ¡ˆæ•°æ®**
    - å¯åŠ¨ç›¸æœºèŠ‚ç‚¹ä¸è¯†åˆ«å™¨ï¼š
        
        ```bash
        ros2 launch rm_detector usb_nav.launch.py
        ```
        
    - å°†è£…ç”²æ¿ç½®äºç›¸æœºè§†é‡ä¸­ï¼Œæ£€æŸ¥ `/detector/img_armor` è¯é¢˜å›¾åƒæ˜¯å¦å‡†ç¡®ã€‚
    - æ”¹å˜è£…ç”²æ¿å§¿æ€ï¼Œç¡®ä¿è§’ç‚¹æ£€æµ‹å‡†ç¡®ï¼Œå½•åˆ¶ rosbagï¼š
        
        ```bash
        ros2 bag record /detector/img_armor -o armor_bag_<id>
        ```
        
        - 1å·è£…ç”²æ¿ï¼š`armor_bag_1`
        - 3å·è£…ç”²æ¿ï¼š`armor_bag_2`
        - å“¨å…µè£…ç”²æ¿ï¼š`armor_bag_3`
    - ä» rosbag æå–å›¾åƒï¼š
        
        ```bash
        python3 extract_bag_bin.py armor_bag_1 datasets/1/
        python3 extract_bag_bin.py armor_bag_2 datasets/2/
        python3 extract_bag_bin.py armor_bag_3 datasets/3/
        ```
        
2. **æ•°æ®é›†ç»“æ„**

ç¡®ä¿æ•°æ®é›†æ–‡ä»¶å¤¹ç»“æ„å¦‚ä¸‹ï¼š

```
datasets
â”œâ”€1/        # 1å·è£…ç”²æ¿å›¾æ¡ˆ
â”œâ”€2/        # 3å·è£…ç”²æ¿å›¾æ¡ˆ
â”œâ”€3/        # å“¨å…µè£…ç”²æ¿å›¾æ¡ˆ
â”œâ”€4negative/ # è´Ÿæ ·æœ¬ï¼ˆCIFAR-100 å¤„ç†åï¼‰
```

1. **è®­ç»ƒæ¨¡å‹**

è¿è¡Œè®­ç»ƒè„šæœ¬ï¼š

```bash
cd ~/ros_ws/src/DT-46-KielasVision/training_scripts
python3 mlp_training.py
```

è®­ç»ƒå®Œæˆåï¼Œç”Ÿæˆçš„ `mlp.onnx` å’Œ `labels.txt` æ–‡ä»¶å°†ä¿å­˜åœ¨ `training_scripts` ç›®å½•ä¸‹ã€‚

1. **å°†æ¨¡å‹æ–‡ä»¶ç§»åˆ°æ­£ç¡®ä½ç½®**

```bash
mv mlp.onnx ~/ros_ws/src/DT-46-KielasVision/rm_detector/model/
mv labels.txt ~/ros_ws/src/DT-46-KielasVision/rm_detector/model/
```

1. **æ›´æ–°å‚æ•°æ–‡ä»¶**

ç¼–è¾‘ `~/ros_ws/src/DT-46-KielasVision/rm_detector/config/detector_params.yaml`ï¼Œç¡®ä¿ `cls_model_file` æŒ‡å‘ `mlp.onnx`ï¼š

```yaml
rm_detector:  ros__parameters:    cls_model_file: 'mlp.onnx'    ...
```

---

## 3. å¯åŠ¨ç³»ç»Ÿ

### USB ç›¸æœºå¯åŠ¨ï¼ˆæ¨èæ–°æ‰‹ï¼‰

```bash
ros2 launch rm_detector usb_nav.launch.py
```

### Hik ç›¸æœºå¯åŠ¨

```bash
ros2 launch rm_detector hik.launch.py
ros2 launch rm_detector hik_nav.launch.py  # å¸¦å¯¼èˆª
```

### MindVision ç›¸æœºå¯åŠ¨

```bash
ros2 launch rm_detector mv.launch.py
ros2 launch rm_detector mv_nav.launch.py  # å¸¦å¯¼èˆª
```

### nav ä¸é nav å¯åŠ¨åŒºåˆ«

- **nav**ï¼šåŒ…å«å¯¼èˆªç›¸å…³åŠŸèƒ½ï¼Œå‘å¸ƒ `/tracker/target` è¯é¢˜ï¼ˆyaw/pitch/shoot_flagï¼‰ã€‚
- **é nav**ï¼šä»…å‘å¸ƒ `/detector/armors_info` è¯é¢˜ï¼Œé€‚åˆè°ƒè¯•æ£€æµ‹å™¨ã€‚

---

## 4. éªŒè¯è¿è¡Œ

### æŸ¥çœ‹è¯é¢˜åˆ—è¡¨

```bash
ros2 topic list
```

é¢„æœŸè¾“å‡ºï¼š

- `/detector/armors_info` (rm_interfaces/msg/ArmorsCppMsg)
- `/tracker/target` (rm_interfaces/msg/ArmorTracking, nav æ¨¡å¼)
- `/detector/bin_img` (sensor_msgs/msg/Image, äºŒå€¼åŒ–å›¾åƒ)
- `/detector/result_img` (sensor_msgs/msg/Image, æ£€æµ‹ç»“æœå›¾åƒ)
- `/detector/img_armor` (sensor_msgs/msg/Image, çŸ©é˜µå˜æ¢åçš„è£…ç”²æ¿å›¾åƒ)

### æ£€æŸ¥è¯é¢˜å¸§ç‡

```bash
ros2 topic hz /detector/armors_info
ros2 topic hz /tracker/target
ros2 topic hz /detector/img_armor
```

### å¯è§†åŒ–æ£€æµ‹ç»“æœ

- **rqt**ï¼š
    
    ```bash
    rqt
    ```
    
    æ‰“å¼€ `Plugins â†’ Visualization â†’ Image View`ï¼Œé€‰æ‹© `/detector/result_img`, `/detector/bin_img` æˆ– `/detector/img_armor`ã€‚
    
- **Foxglove**ï¼š
    
    ```bash
    ros2 launch foxglove_bridge foxglove_bridge_launch.xml port:=8765
    ```
    
    æ‰“å¼€ Foxglove Studioï¼Œè¿æ¥ `ws://localhost:8765`ï¼ŒæŸ¥çœ‹å›¾åƒä¸ `/detector/armors_info`ã€‚
    




- äºŒå€¼åŒ–å›¾åƒï¼š

![bin.png](å¿«é€Ÿå¼€å§‹-æ•™ç¨‹æ–‡æ¡£/bin.png)

- çŸ©é˜µå˜æ¢åçš„è£…ç”²æ¿å›¾åƒ + æ£€æµ‹ç»“æœï¼š

![solve+res.jpg](å¿«é€Ÿå¼€å§‹-æ•™ç¨‹æ–‡æ¡£/solve+res.png)

---

## 5. å‚æ•°è°ƒè¯•ä¸é…ç½®

### åŠ¨æ€è°ƒå‚ï¼ˆå‘½ä»¤è¡Œï¼‰

```bash
# åˆ‡æ¢æ˜¾ç¤ºæ¨¡å¼ï¼ˆåŒæ—¶å‘å¸ƒäºŒå€¼åŒ–ä¸è¯†åˆ«ç»“æœå›¾ï¼‰
ros2 param set /rm_detector display_mode 2
# è°ƒèŠ‚äºŒå€¼åŒ–é˜ˆå€¼
ros2 param set /rm_detector binary_val 120
# è°ƒèŠ‚è¿½è¸ªé¢œè‰²ï¼ˆ0=çº¢, 1=è“, 10=ä¸è¿½è¸ªï¼‰
ros2 param set /rm_tracker tracking_color 0
```

### åŠ¨æ€è°ƒå‚ï¼ˆrqt GUIï¼‰

- æ‰“å¼€ï¼š`Plugins â†’ Configuration â†’ Parameters`
- é€‰æ‹© `/rm_detector` æˆ– `/rm_tracker`
- ä¿®æ”¹ `display_mode`, `binary_val`, `tracking_color` ç­‰å‚æ•°

### ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼ˆæŒä¹…åŒ–ï¼‰

- æ£€æµ‹å™¨å‚æ•°æ–‡ä»¶ï¼š`~/ros_ws/src/DT-46-KielasVision/rm_detector/config/detector_params.yaml`
- è¿½è¸ªå™¨å‚æ•°æ–‡ä»¶ï¼š`~/ros_ws/src/DT-46-KielasVision/rm_tracker/config/tracker_params.yaml`

ä¿®æ”¹åé‡æ–°è¿è¡Œ launch æ–‡ä»¶å³å¯ç”Ÿæ•ˆã€‚

---

## 6. æˆåŠŸæ ‡å¿—

- ç»ˆç«¯è¾“å‡ºæ£€æµ‹ä¸è¿½è¸ªæ—¥å¿—
- `/detector/armors_info` æŒç»­è¾“å‡º
- `/tracker/target` æ­£å¸¸å‘å¸ƒ
- rqt/foxglove å¯è§è£…ç”²æ¿è¯†åˆ«ç»“æœ

---

## 7. å¼€å‘ç¯å¢ƒä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰

æ¨èåœ¨ `~/.bashrc` æ·»åŠ ä»¥ä¸‹ alias æå‡æ•ˆç‡ï¼š

```bash
alias sb='source ~/.bashrc'
alias eb='nano ~/.bashrc'
alias cb='rm -rf build install log && colcon build --symlink-install'
alias si='source install/setup.bash'
alias rvh='ros2 launch rm_detector hik.launch.py'
alias rvnh='ros2 launch rm_detector hik_nav.launch.py'
alias rvm='ros2 launch rm_detector mv.launch.py'
alias rvnm='ros2 launch rm_detector mv_nav.launch.py'
alias rvnu='ros2 launch rm_detector usb_nav.launch.py'
alias rf='cd ~/ros_ws && source install/setup.bash && ros2 launch foxglove_bridge foxglove_bridge_launch.xml port:=8765'
alias stop='pkill -9 -f ros2'
```

---

## 8. å¸¸è§é—®é¢˜

- **ç›¸æœºæ— æ³•æ‰“å¼€**ï¼šæ£€æŸ¥ `/dev/video0` æ˜¯å¦å­˜åœ¨ï¼Œæ˜¯å¦è¢«å…¶ä»–ç¨‹åºå ç”¨ï¼ˆ`fuser /dev/video0`ï¼‰
- **æ²¡æœ‰æ£€æµ‹ç»“æœ**ï¼šç”¨ **rqt** æŸ¥çœ‹ `/detector/bin_img`ï¼Œè°ƒèŠ‚ `binary_val`
- **å¸§ç‡è¿‡ä½**ï¼šé™ä½åˆ†è¾¨ç‡æˆ–å…³é—­ `display_mode` å¯è§†åŒ–
- **èŠ‚ç‚¹æœªå¯åŠ¨**ï¼šç¡®è®¤å·²æ‰§è¡Œ `source /opt/ros/humble/setup.bash` ä¸ `source install/setup.bash`
- **è®­ç»ƒå¤±è´¥**ï¼šæ£€æŸ¥ PyTorch ç‰ˆæœ¬ã€æ•°æ®é›†è·¯å¾„ã€å›¾ç‰‡æ ¼å¼æ˜¯å¦æ­£ç¡®

---

## 9. ä¸‹ä¸€æ­¥

- **æ“ä½œæŒ‡å—**ï¼šåˆ‡æ¢ç›¸æœºé©±åŠ¨ï¼ˆHik / MindVisionï¼‰ã€å¯ç”¨ä¸²å£é€šä¿¡â€¦
- **å‚è€ƒæ–‡æ¡£**ï¼šå®Œæ•´å‚æ•°æ¸…å•ã€è¯é¢˜ä¸æ¶ˆæ¯ç±»å‹â€¦
- **è§£é‡Šæ–‡æ¡£**ï¼šIMM è¿½è¸ªç®—æ³•ä¸å¼¹é“è¡¥å¿åŸç†â€¦

---

âœ… è‡³æ­¤ï¼Œä½ å·²ç»èƒ½æˆåŠŸè¿è¡Œ `DT-46-KielasVision` é¡¹ç›®ã€‚