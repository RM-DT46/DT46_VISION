# 食用指南-操作指南

本章节提供 **具体任务的操作方法**，不解释原理，仅给出解决步骤和验证方式。

---

## 目录

1. 相机相关
    
    1.0 相机驱动安装
    
    1.1 切换相机驱动
    
    1.2 修改相机参数
    
    1.3 相机标定流程
    
2. 视觉调试
    
    2.1 调整 detector 参数
    
    2.2 调整 tracker 参数
    
    2.3 使用 rqt 动态调参
    
    2.4 训练并替换分类器模型
    
3. 系统运行
    
    3.1 启用串口通信
    
    3.2 开机自启配置
    
4. 可视化工具
    
    4.1 使用 rqt Image View
    
    4.2 使用 Foxglove
    
5. 踩坑
    
    5.1 多机话题冲突
    
    5.2 权限不足
    
    5.3 依赖缺失
    
    5.4 OpenCV / GLIBCXX 版本问题
    
    5.5 ROS2 守护进程异常
    
    5.6 相机帧率过低 / 画面卡顿
    
    5.7 编译速度慢 / CPU 占用过高
    
    5.8 网络连接问题
    
    5.9 GRUB 卡住
    
    5.10 文件系统损坏风险
    
    5.11 内存不足 / 程序崩溃
    
    5.12 SSH 频繁掉线
    
6. 调试常用命令速查表

---

## 1. 相机相关

### 1.0 相机驱动安装

- **MindVision**: [SDK 下载](https://www.mindvision.ltd/Service-Support/Software-Download.html)
- **HikRobot**: [SDK 下载](https://www.hikrobotics.com/cn/machinevision/service/download/?module=0)
安装后确认 `/image_raw` 正常发布。

### 1.1 切换相机驱动

```bash
ros2 launch rm_vision_bringup usb_nav.launch.py   # USB 相机
ros2 launch rm_vision_bringup hik_nav.launch.py   # Hik 相机
ros2 launch rm_vision_bringup mv_nav.launch.py    # MindVision 相机
```

验证：运行 `ros2 topic hz /image_raw`，检查帧率是否正常。

### 1.2 修改相机参数

1. 打开对应相机包的 `config/*.yaml` 文件。
2. 修改参数，如分辨率、帧率、曝光。
3. 重启 launch 文件。

验证：使用 `rqt` 查看 `/image_raw`，确认变化生效。

### 1.3 相机标定流程

1. 安装标定工具：
    
```bash
sudo apt update
sudo apt install ros-humble-camera-calibration
```
    
2. 打印标定板（8x11 棋盘格，格子大小 14mm）。
- 8x11 是 内角点数（每行每列的交叉点数），不是方格数。

- 如果你的标定板是 9x12 个方格，--size 就应该是 8x11。

- --square 是每个方格边长，单位 米，确保测量正确。
标定黑白格生成:
[Camera Calibration Pattern Generator](https://calib.io/pages/camera-calibration-pattern-generator)
3. 启动相机节点
4. 运行标定：
    
```bash

ros2 run camera_calibration cameracalibrator --size 7x10 --square 0.014 --ros-args --remap image:=/image_raw --remap camera:=/camera

```
    
5. 移动标定板采集数据，直到进度条满。
6. 点击 “Calibrate” 计算内参，保存到文件。
7. 将标定结果复制到相机 config 的 `camera_info_url` 或手动编辑 yaml。

验证：检查 PnP 位姿估计是否准确（dx, dy, dz 合理）。

---

## 2. 视觉调试

### 2.1 调整 detector 参数

1. 动态调参（命令行）：
    
    ```bash
    ros2 param set /rm_detector binary_val 120
    ros2 param set /rm_detector detect_color 0  # 0=红, 1=蓝, 2=自适应ros2 param set /rm_detector display_mode 2  # 0=关闭, 1=二值化, 2=全部
    ```
    
2. 持久化修改：编辑 `rm_detector/config/detector_params.yaml`，重启节点。

验证：用 rqt 查看 `/detector/bin_img` 和 `/detector/result_img`，确认灯条/装甲板检测准确。

### 2.2 调整 tracker 参数

1. 动态调参：
    
    ```bash
    ros2 param set /rm_tracker tracking_color 0  # 0=红, 1=蓝, 10=不追踪ros2 param set /rm_tracker shoot_yaw_max 1.5
    ros2 param set /rm_tracker bullet_speed_mps 30.0
    ```
    
2. 持久化：编辑 `rm_tracker/config/tracker_params.yaml`，重启节点。

验证：检查 `/tracker/target` 话题，yaw/pitch/shoot_flag 合理；终端日志显示 FPS 和追踪状态。

### 2.3 使用 rqt 动态调参

1. 启动 rqt：
    
    ```bash
    rqt
    ```
    
2. 打开 `Plugins → Configuration → Parameters`。
3. 选择节点（如 `/rm_detector` 或 `/rm_tracker`）。
4. 修改参数值，按 Enter 应用。

验证：参数变化立即生效，观察话题输出或图像变化。

### 2.4 训练并替换分类器模型

1. 创建数据集文件夹：
    
    ```bash
    mkdir -p ~/ros_ws/src/DT-46-KielasVision/datasets/{1,2,3,4negative}
    ```
    
2. 处理负样本（CIFAR-100）：
    - 下载数据集：[CIFAR-100](https://www.cs.toronto.edu/~kriz/cifar.html)
    - 解压后运行：
        
        ```bash
        cd ~/ros_ws/src/DT-46-KielasVision/training_scripts
        python3 process_cifra100.py
        ```
        
3. 采集正样本：
    - 启动系统：
        
        ```bash
        ros2 launch rm_vision_bringup usb_nav.launch.py
        ```
        
    - 将装甲板置于视野，检查 `/detector/img_armor` 图像准确。
    - 录制 rosbag：
        
        ```bash
        ros2 bag record /detector/img_armor -o armor_bag_<id>
        ```
        
        - 1号：armor_bag_1 → datasets/1/
        - 3号：armor_bag_2 → datasets/2/
        - 哨兵：armor_bag_3 → datasets/3/
    - 提取图像：
        
        ```bash
        python3 extract_bag_bin.py armor_bag_1 datasets/1/
        ```
        
        （类似处理其他 bag）
        
4. 训练模型：
    
    ```bash
    python3 mlp_training.py
    ```
    
5. 替换模型：
    
    ```bash
    mv mlp.onnx ~/ros_ws/src/DT-46-KielasVision/rm_detector/model/
    mv labels.txt ~/ros_ws/src/DT-46-KielasVision/rm_detector/model/
    ```
    
6. 更新参数：
编辑 `rm_detector/config/detector_params.yaml`：
    
    ```yaml
    cls_model_file: 'mlp.onnx'
    ```
    
7. 重启系统。

验证：检查检测日志，class_id 正确；准确率提升。

---

## 3. 系统运行

### 3.1 启用串口通信

1. 连接串口设备（/dev/ttyUSB0）。
2. 启动串口节点：
    
    ```bash
    ros2 launch rm_serial_python rm_serial.launch.py
    ```
    
3. 或在主 launch 中启用（默认已含）。

验证：检查 `/nav/decision` 话题接收 detect_color；串口日志无错误。

### 3.2 开机自启配置

1. 创建脚本 `~/ros_startup.sh`：
    
    ```bash
    #!/bin/bashsource /opt/ros/humble/setup.bash
    source ~/ros_ws/install/setup.bash
    ros2 launch rm_vision_bringup usb_nav.launch.py
    ```
    
2. 赋予权限：
    
    ```bash
    chmod +x ~/ros_startup.sh
    ```
    
3. 添加到 crontab：
    
    ```bash
    crontab -e@reboot ~/ros_startup.sh
    ```
    

验证：重启机器，检查 `ros2 node list` 有节点运行。

---

## 4. 可视化工具

### 4.1 使用 rqt Image View

1. 启动 rqt。
2. `Plugins → Visualization → Image View`。
3. 选择话题如 `/detector/result_img`。

验证：实时显示图像。

### 4.2 使用 Foxglove

1. 启动 bridge：
    
    ```bash
    ros2 launch foxglove_bridge foxglove_bridge_launch.xml port:=8765
    ```
    
2. 打开 Foxglove Studio，连接 ws://localhost:8765。

验证：查看话题数据和图像。

---

## 5. 踩坑

### 5.1 多机话题冲突

问题：多机下话题重名导致混乱。

解决：使用 namespace，在 launch 添加 `--namespace ns1`。

### 5.2 权限不足

问题：无法打开 /dev/video0 或 /dev/ttyUSB0。

解决：

```bash
sudo chmod 666 /dev/video0
sudo chmod 666 /dev/ttyUSB0
sudo usermod -aG dialout $USER
```

### 5.3 依赖缺失

问题：编译报错缺少包。

解决：

```bash
rosdep install --from-paths src --ignore-src -r -y
```

### 5.4 OpenCV / GLIBCXX 版本问题

问题：版本冲突。

解决：使用系统 OpenCV，或编译自定义版本。

### 5.5 ROS2 守护进程异常

问题：`ros2 daemon stop` 无效。

解决：

```bash
rm -rf ~/.ros/rtps_guids
ros2 daemon start
```

### 5.6 相机帧率过低 / 画面卡顿

问题：帧率 < 30 FPS。

解决：降低分辨率、关闭 display_mode、优化网络。

### 5.7 编译速度慢 / CPU 占用过高

问题：colcon build 慢。

解决：添加 `--parallel-workers 4` 限制线程。

### 5.8 网络连接问题

问题：SSH 连接工业 PC 失败。

解决：确认 IP，ping 测试；编辑 ~/.ssh/config 添加 KeepAlive。

### 5.9 GRUB 卡住

问题：掉电后 GRUB 30s 倒计时。

解决：编辑 /etc/default/grub，添加 GRUB_RECORDFAIL_TIMEOUT=3；update-grub。

### 5.10 文件系统损坏风险

问题：掉电导致分区损坏。

解决：设置根分区 ro，挂载 /data 为 rw。

### 5.11 内存不足 / 程序崩溃

问题：OOM。

解决：创建 4G Swap 文件。

### 5.12 SSH 频繁掉线

问题：闲置断开。

解决：编辑 /etc/ssh/sshd_config，添加 ClientAliveInterval 60；重启 ssh。

---

## 6. 调试常用命令速查表

### 查看话题

```bash
ros2 topic list
ros2 topic hz /detector/armors_info
```

### 参数操作

```bash
ros2 param list
ros2 param set /rm_detector binary_val 120
ros2 param set /rm_tracker tracking_color 0
```

### 启动节点

```bash
ros2 launch rm_vision_bringup usb_nav.launch.py
ros2 launch rm_serial_python rm_serial.launch.py
```

### 可视化

```bash
rqtros2 launch foxglove_bridge foxglove_bridge_launch.xml port:=8765
```

### 编译 & 清理

```bash
colcon build --symlink-installrm -rf build install log && colcon build --symlink-install
```

### 权限问题

```bash
sudo chmod 777 /dev/video0
sudo chmod 777 /dev/ttyUSB0
```

---