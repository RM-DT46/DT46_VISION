# 购物清单-参考文档

# 参考文档

## 1. 软件包总览

### 1.1 包清单

工作空间 `ros_ws/src` 下包含以下软件包：

- **rm_interfaces**
    
    自定义消息与接口定义。
    
- **DT-46-KielasVision**
    - `rm_detector`：装甲板检测节点。
    - `rm_tracker`：装甲板追踪节点。
- **rm_serial_python**
    
    串口通信模块（Python 实现）。
    
- **rm_vision_DT46**
    
    系统整合启动文件。
    
    - `rm_vision_bringup/launch/`：包含所有 launch 文件。
- **rm_vision_ros2_hik_camera**
    
    Hik 工业相机驱动节点。
    
- **rm_vision_ros2_mindvision_camera**
    
    MindVision 工业相机驱动节点。
    
- **rm_vision_ros2_usb_camera**
    
    通用 USB 相机驱动节点。
    

---

### 1.2 依赖关系

- **rm_detector**
    
    依赖：`rclcpp`, `sensor_msgs`, `std_msgs`, `cv_bridge`, `opencv4`, `rm_interfaces`
    测试依赖：`ament_lint_auto`, `ament_lint_common`
    
- **rm_tracker**
    
    依赖：`rclpy`, `std_msgs`, `rm_interfaces`
    测试依赖：`ament_copyright`, `ament_flake8`, `ament_pep257`, `python3-pytest`
    
- **rm_serial_python**
    
    依赖：`rclpy`, `pyserial`, `rm_interfaces`
    
- **rm_interfaces**
    
    依赖：`rosidl_default_generators`, `std_msgs`
    
- **相机驱动包**
    - `hik_camera`：依赖 `rclcpp`, `rclcpp_components`, `sensor_msgs`, `image_transport`, `camera_info_manager`
    - `mindvision_camera`：依赖 `rclcpp`, `rclcpp_components`, `sensor_msgs`, `image_transport`, `camera_info_manager`
    - `usb_camera`：依赖 `rclcpp`, `sensor_msgs`, `image_transport`, `cv_bridge`, `camera_info_manager`, `OpenCV`
- **rm_vision_bringup**
    
    依赖：`DT-46-KielasVision`, `rm_interfaces`
    

---

## 2. 启动文件

所有启动文件位于：

`rm_vision_DT46/rm_vision_bringup/launch/`

---

### 2.1 hik.launch.py

- **启动节点**
    - `hik_camera_node`
    - `armor_detector_opencv_node`
    - `armor_tracker_node`
    - `rm_serial_node`
- **功能**
    - 启动 Hik 相机驱动。
    - 运行装甲板检测与追踪。
    - 通过串口与电控通信。

---

### 2.2 hik_nav.launch.py

- **启动节点**
    - 同 `hik.launch.py`，但启用导航模式。
    - 额外发布 `/tracker/target` 话题（yaw/pitch/shoot_flag）。

---

### 2.3 mv.launch.py

- **启动节点**
    - `mindvision_camera_node`
    - `armor_detector_opencv_node`
    - `armor_tracker_node`
    - `rm_serial_node`
- **功能**
    - 启动 MindVision 相机驱动。
    - 运行装甲板检测与追踪。
    - 通过串口与电控通信。

---

### 2.4 mv_nav.launch.py

- **启动节点**
    - 同 `mv.launch.py`，但启用导航模式。
    - 额外发布 `/tracker/target` 话题。

---

### 2.5 usb.launch.py

- **启动节点**
    - `usb_camera_node`
    - `armor_detector_opencv_node`
    - `armor_tracker_node`
    - `rm_serial_node`
- **功能**
    - 启动 USB 相机驱动。
    - 运行装甲板检测与追踪。
    - 通过串口与电控通信。

---

### 2.6 usb_nav.launch.py

- **启动节点**
    - 同 `usb.launch.py`，但启用导航模式。
    - 额外发布 `/tracker/target` 话题。

---

## 3. 节点说明

### 3.1 armor_detector_opencv_node

- **包**: `rm_detector`
- **订阅**
    - `/image_raw` (sensor_msgs/msg/Image): 相机原始图像。
    - `/camera_info` (sensor_msgs/msg/CameraInfo): 相机内参。
- **发布**
    - `/detector/armors_info` (rm_interfaces/msg/ArmorsCppMsg): 装甲板信息（armor_id, cx, cy, height）。
    - `/detector/bin_img` (sensor_msgs/msg/Image): 二值化图像。
    - `/detector/result_img` (sensor_msgs/msg/Image): 检测结果图像。
    - `/detector/img_armor` (sensor_msgs/msg/Image): 矩阵变换后的装甲板图像。
- **参数**
    - 配置文件：`rm_detector/config/detector_params.yaml`
    - 动态调参支持：`binary_val`, `detect_color`, `display_mode`, etc.

---

### 3.2 armor_tracker_node

- **包**: `rm_tracker`
- **订阅**
    - `/detector/armors_info` (rm_interfaces/msg/ArmorsCppMsg): 装甲板检测结果。
    - `/nav/decision` (rm_interfaces/msg/Decision): 电控下发的决策（detect_color）。
- **发布**
    - `/tracker/target` (rm_interfaces/msg/ArmorTracking): 追踪结果（yaw, pitch, shoot_flag）。
- **参数**
    - 配置文件：`rm_tracker/config/tracker_params.yaml`
    - 动态调参支持：`tracking_color`, `shoot_yaw_max`, `shoot_pitch_max`, etc.

---

### 3.3 rm_serial_node

- **包**: `rm_serial_python`
- **订阅**
    - `/tracker/target` (rm_interfaces/msg/ArmorTracking): 追踪结果。
- **发布**
    - `/nav/decision` (rm_interfaces/msg/Decision): 电控下发的决策。
- **参数**
    - `device_name`, `baud_rate`, `flow_control`, `parity`, `stop_bits`

---

### 3.4 相机节点

- **hik_camera_node** (`rm_vision_ros2_hik_camera`)
- **mindvision_camera_node** (`rm_vision_ros2_mindvision_camera`)
- **usb_camera_node** (`rm_vision_ros2_usb_camera`)
- **发布**
    - `/image_raw` (sensor_msgs/msg/Image)
    - `/camera_info` (sensor_msgs/msg/CameraInfo)

---

## 4. 参数说明

### 4.1 rm_detector 参数

- **配置文件**: `rm_detector/config/detector_params.yaml`
- **关键参数**
    - `cls_model_file`: ONNX 模型路径 (默认 `mlp.onnx`)。
    - `cls_invert_binary`: 是否反转二值化图像 (默认 `false`)。
    - `light_area_min`: 灯条最小面积。
    - `light_h_w_ratio`: 灯条高宽比。
    - `light_angle_min/max`: 灯条角度范围。
    - `light_red_ratio/blue_ratio`: 红/蓝灯条颜色比例。
    - `height_rate_tol`: 装甲板高度容差。
    - `height_multiplier_min/max`: 装甲板高度倍数范围。
    - `binary_val`: 二值化阈值。
    - `detect_color`: 检测颜色 (0=红, 1=蓝, 2=自适应)。
    - `display_mode`: 显示模式 (0=关闭, 1=仅二值化, 2=全部)。

---

### 4.2 rm_tracker 参数

- **配置文件**: `rm_tracker/config/tracker_params.yaml`
- **关键参数**
    - `log_throttle_ms`: 日志节流时间 (ms)。
    - `fps_window_sec`: FPS 统计窗口 (秒)。
    - `use_kf`: 是否启用卡尔曼滤波。
    - `frame_add`: 目标丢失前保留帧数。
    - `tracking_color`: 追踪颜色 (0=红, 1=蓝, 10=不追踪)。
    - `follow_decision`: 是否跟随决策模块 (0=否, 1=是)。
    - `track_deep_tol`: 追踪深度容差 (mm)。
    - `shoot_yaw_max/pitch_max`: 最大允许 yaw/pitch 角度 (deg)。
    - `camera_tx_m/ty_m/tz_m`: 相机平移 (米)。
    - `camera_yaw_deg/pitch_deg/roll_deg`: 相机旋转 (度)。
    - `kf_sigma_acc/jerk`: 卡尔曼滤波加速度/jerk 噪声标准差。
    - `kf_meas_std`: 测量噪声标准差。
    - `kf_mu_cv/ca`: CV/CA 模型权重。
    - `kf_trans_00/01/10/11`: 模型转移概率。
    - `kf_a_init_std`: 初始加速度标准差。
    - `use_ballistics`: 是否启用弹道补偿。
    - `bullet_speed_mps`: 弹速 (m/s)。
    - `gravity`: 重力加速度 (m/s²)。
    - `extra_latency_s`: 额外延迟补偿 (秒)。

---

### 4.3 相机参数

- **Hik/MindVision/USB 相机**
    - 配置文件：各自包内的 `config/*.yaml`
    - 参数：分辨率、帧率、曝光时间、增益等。

---

## 5. 话题说明

### 5.1 订阅话题

- `/image_raw` (sensor_msgs/msg/Image): 相机原始图像。
- `/camera_info` (sensor_msgs/msg/CameraInfo): 相机内参。
- `/detector/armors_info` (rm_interfaces/msg/ArmorsCppMsg): 装甲板检测结果。
- `/nav/decision` (rm_interfaces/msg/Decision): 电控决策。

### 5.2 发布话题

- `/detector/armors_info` (rm_interfaces/msg/ArmorsCppMsg): 装甲板信息。
- `/detector/bin_img` (sensor_msgs/msg/Image): 二值化图像。
- `/detector/result_img` (sensor_msgs/msg/Image): 检测结果图像。
- `/detector/img_armor` (sensor_msgs/msg/Image): 矩阵变换后的装甲板图像。
- `/tracker/target` (rm_interfaces/msg/ArmorTracking): 追踪结果。
- `/nav/decision` (rm_interfaces/msg/Decision): 电控下发的决策。

---

## 6. 消息格式

### 6.1 ArmorsCppMsg.msg

- **std_msgs/Header header**
- **ArmorCppInfo[] armors**

---

### 6.2 ArmorCppInfo.msg

- **int32 armor_id**
- **float32 dx**
- **float32 dy**
- **float32 dz**

---

### 6.3 ArmorTracking.msg

- **float32 yaw**
- **float32 pitch**
- **bool shoot_flag**

---

### 6.4 Decision.msg

- **int8 color**

---

### 6.5 串口协议相关 (C++ 结构体实现，未单独 msg 化)

- **SendPacket**
    - `uint8_t header = 0x5A`
    - `float32 yaw`
    - `float32 pitch`
    - `uint8_t shoot`
    - `int32 match`
- **ReceivePacket**
    - `uint8_t header = 0xA5`
    - `uint8_t detect_color`
    - `float32 roll`
    - `float32 pitch`
    - `float32 yaw`
    - `int32 match`
    - `uint16_t checksum`

---

## 7. 串口通信协议

节点：`rm_serial_python`

代码位置：`rm_serial_node.py`

---

### 7.1 串口参数

- **device_name**: 串口设备路径 (默认 `/dev/ttyUSB0`)
- **baud_rate**: 波特率 (默认 `115200`)
- **flow_control**: 流控 (默认 `0`)
- **parity**: 校验位 (默认 `0`)
- **stop_bits**: 停止位 (默认 `1`)

---

### 7.2 视觉 → 电控 (发送报文)

- **触发**: 接收 `/tracker/target` 消息后发送
- **格式**: `<BffBi>` (小端序, 共 14 字节)
    - `header`: `uint8` 固定 `0x5A`
    - `yaw`: `float32`
    - `pitch`: `float32`
    - `shoot`: `uint8` (0/1)
    - `match`: `int32` (发送序号, 自增循环)

---

### 7.3 电控 → 视觉 (接收报文)

- **长度**: 20 字节
- **格式**: `<BBfffiH>` (小端序)
    - `header`: `uint8` 固定 `0xA5`
    - `detect_color`: `uint8` (0=红, 1=蓝)
    - `roll`: `float32`
    - `pitch`: `float32`
    - `yaw`: `float32`
    - `match`: `int32`
    - `checksum`: `uint16` (尾部校验, 当前未使用)

---

### 7.4 ROS2 话题映射

- **订阅**: `/tracker/target` → 打包并发送串口
- **发布**: `/nav/decision` → 发布接收到的 `detect_color`

---

### 7.5 校验与约定

- 报文使用 **小端序**。
- **发送包** 不带校验。
- **接收包** 包含校验字段，但当前实现未做校验验证。
- `detect_color` 约定: **0=红, 1=蓝**。

---